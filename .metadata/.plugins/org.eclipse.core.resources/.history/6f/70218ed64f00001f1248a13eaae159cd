<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<!-- 기본적으로 jstl/el 을 쓴다 레거시 프로젝트에는 기본적으로 jstl 라이브러리가 담아져있다 
고로 로드하는 코드만 적어준다 메이븐 dependencies 폴더를 안을 보면 jstl 라이브러리가 보인다 -->
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<c:set var="cpath" value="${pageContext.request.contextPath}" />
<!-- == controller가져온 것임  -->
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

<!-- jQuery library -->
<script
	src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

<!-- Popper JS -->
<script
	src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

<!-- Latest compiled JavaScript -->
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- 자동완성 기능을 위해 가져온  jquery-ui  -->

<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
<link rel = "stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/smoothness/jquery-ui.css">
</head>

<body>
	<!-- 이 jsp를 화면에 보이게 하려면 스프링의 ds(디스패쳐서블릿)는 항상 controller 이라는
 클래스를 실행시키게 되어있으므로 개발자는 controller클래스를 생성해야 한다 -->
	<div class="jumbotron">
		<h1>빅데이터 23차 게시판</h1>
		<p>Bootstrap을 사용하여 게시판 만들자</p>
	</div>

	<div class="container">
		<div class="card">
			<div class="card-header">게시판 연습</div>
			<div class="card-body">

				<form id="searchForm" onsubmit="return false" class="form-inline">
					<div align="right" class="form-group">
						<select name="type" class="form-control btn-warning" id="sel1">
							<option class="btn-light">작성자</option>
							<option class="btn-light">제목</option>
						</select>
					</div>
					<input id = "auto_complete" name="text" type="text" class="form-control"> <input
						id="searchBtn" type="submit" class="btn btn-warning" value="검색">

				</form>
				<br>
				<table id="myTable" class="table table-bodered table-hover">
					<tr>
						<td>번호</td>
						<td>제목</td>
						<td>작성자</td>
						<td>게시글</td>
						<td>작성일</td>
					</tr>
					<!-- jstl/el 을 사용하여 model 안에 저장된 게시글 정보를 전부 화면에 출력 -->
					<c:forEach items="${list}" var="b">
						<tr>
							<td>${b.idx}</td>
							<td>
								<!-- 1.쿼리 스트링으로 데이터 보내기 
						     2. 경로상에 그냥 바로 데이터 포함해서 보내기--> <!-- <a href="${cpath}/boardContent?idx=${b.idx}">${b.title}</a> -->
								<a href="${cpath}/boardContent/${b.idx}">${b.title}</a>
							</td>
							<td>${b.writer}</td>
							<td>${b.content}</td>
							<td>${b.inDate}</td>
						</tr>
					</c:forEach>
				</table>
				<!-- onclick은 get 전송방식  -->
				<button onclick="location.href='${cpath}/register'"
					class="btn btn-primary btn-sm">글쓰기</button>
			</div>
			<div class="card-footer">게시판Footer</div>
		</div>
	</div>


	<script type="text/javascript">
	
	
	// 페이지가 첫번째로 실행되었을때도 AutoComplete 되게 만들기
	$(function(){
		myAjaxAutoComplete();

	})
	
	
	// selsct 태그의 값이 변경시 이벤트 처리
	$("#sel1").on("chang",function () {
		myAjaxAutoComplete();	
	})
	
	// --> 참조기법 $("#sel1").on("chang",myAjaxAutoComplete)
	
	// 비동기 통신을 사용하여 작성자 ,제목 리스트를 전부 조회
	// 요청 경로 : /autocomplete
	function myAjaxAutoComplete(){
		$.ajax({
			url : "${cpath}/autocomplete",
			// 쿼리 스트링 -->  ?type = 작성자
		    // type --> SearchCriteria클래스
			data : {type : $("#sel1").val()},
			dataType : "json",
			
			success: function(res) {
				console.log("받아온 데이터 >> ", res);
				//객체 배열 --> 문자열 배열로 변경
				// 1. 비어있는 배열 생성 
	  			var sourceList =[];
				// 2.RES의 길이 만큼 반복하면서 안쪽에 있는 writer 데이터만 꺼내서 비어있는 배열에 추가
				for(let i = 0; i < res.length; i++) {
					sourceList.push(res[i].writer);
					sourceList.push(res[i].title);
				}
				myAuto(sourceList);
			},
		
			error :function(e){
				console.log(e);
			}	
		})
	}
/////////////////////////////////////////////////////
	
	// 함수만들기
	function myAuto(sourceList) {
	// jquery-ui 를 사용해서 input 태그 아래쪽에 글자 자동완성 기능 넣어보기
	$("#auto_complete").autocomplete({
		// 1. 자동완성 하고 싶은 목록 --> 원래는 디비에서 가져옴 : 리스트단위로~
		source : sourceList,
		// 2. 최소글자
		minlength : 1,
		// 3. 딜레이 시간 0.1초
		delay : 100,
		// 4. 해당요소에 포커싱 되었을때 작동할 함수
		focus : function(e,ui){
			// e =이벤트 ui = 화면구성
			return false;
		}
		
	   })
	}

	// 1. searchBtn 클릭시 이벤트 등록
	$("#searchBtn").on("click",function () {
		
	// 2. id값이 searchForm 안에 있는 데이터를 가져오기	
	var data =$("#searchForm").serialize(); // 병렬 데이터를 직렬로~~
				
	// 3.가져온 데이터 출력하기
	console.log(data);
	
	// 4) 비동기 통신 사용하여 데이터 전송(/search)
	$.ajax({
	
		url : "${cpath}/search",
		data : data,
		type : "get",
		dataType : "json",
		success: function(res) {
			console.log(res);
			
			
		//연재방식	
        // $("body > div.container > div > div.card-body > table").html(`
        //          <tr id=>
         //            <td>번호</td>
         //            <td>제목</td>
          //           <td>작성자</td>
          //           <td>작성일</td>
          //        </tr>`);
            //   for(let i = 0; i < res.length; i++) {
               //   $("body > div.container > div > div.card-body > table").append(`
              //          <tr>
               //            <td>` + res[i].idx + `</td>
               //            <td>` + res[i].title + `</td>
               //            <td>` + res[i].writer + `</td>
               //            <td>` + res[i].inDate + `</td>
               //         </tr>`);
             // }
            
            // 1. column을 제외한 나머지 행들을 비워주기
            // tr:first-child~tr:  ~은 후행이라는 의미  
            $("#myTable tbody tr:first-child~tr").empty();
             
            //2. res(배열)에 담긴 데이터 개수만큼 반복
             $.each(res,function(i,board){
            	 //3. tr태그를 추가
            	 var tr = `
            		 <tr>
						<td>\${board.idx}</td>
						<td>
					    <a href="${cpath}/boardContent/\${board.idx}">\${board.title}</a>
						</td>
						<td>\${board.writer}</td>
						<td>\${board.content}</td>
						<td>\${board.inDate}</td>
					</tr> `
            	$("#myTable tbody").append(tr);
            	  
             })
					
		},
		
		error :function(e){
			console.log(e);
		}
		
	})
	
})
	
	</script>



</body>
</html>